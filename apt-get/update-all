#!/usr/bin/env bash

#sudo do nothing or fail
sudo true || (echo "Root is needed to perform an upgrade! Abort!" & kill $$)

#update the repository cache
echo 'Updating the repository cache...'
sudo apt-get -ymuq update >/dev/null || (echo "Something went wrong during this stage! Stopping!" & kill $$)

#Store the output of a simulated upgrade
echo 'Checking for upgraded packages...'
RET=$(sudo apt-get -qs --assume-no upgrade || (kill $$))
MSG=$(echo -e "Reading package lists...\nBuilding dependency tree...\nReading state information...\n0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.")

if [ "$RET" = "$MSG" ]; then #$MSG has to be a variable because $RET contains newlines, which we can't get without echoing
  MORE=''
else
  while [ ! "$RET" = "$MSG" ]; do
    
    #upgrade all the 'mundane' programs
    echo 'Upgrading user packages...'
    echo 'Please be patient; this can take a while.'
    sudo apt-get -ymuq upgrade >/dev/null || (echo "Something went wrong during this stage! Stopping!" & kill $$)
    
    #upgrade the distro and system files
    echo 'Upgrading distro and system files...'
    echo 'Please be patient; this can take a while.'
    sudo apt-get -ymuq dist-upgrade >/dev/null || (echo "Something went wrong during this stage! Stopping!" & kill $$)
    
    #uninstall all unnecessary/orphaned packages
    echo 'Removing unneeded packages...'
    sudo apt-get -ymuq autoremove >/dev/null || (echo "Something went wrong during this stage! Stopping!" & kill $$)
    
    #delete all unnecessary packages left over
    echo 'Cleaning up...'
    sudo apt-get -ymuq autoclean >/dev/null || (echo "Something went wrong during this stage! Stopping!" & kill $$)
    
    #update the repository cache
    echo 'Updating the repository cache...'
    sudo apt-get -ymuq update >/dev/null || (echo "Something went wrong during this stage! Stopping!" & kill $$)
    
    #update the simulated upgrade
    echo 'Checking for more upgraded packages...'
    RET=$(sudo apt-get -qs --assume-no upgrade || (kill $$))
  
  done
  MORE=' more'
fi
echo "No$MORE upgrades are available at this time."
